#!/usr/bin/perl -w

use strict;
use Getopt::Long;

# helper code to inline the Standard Prelude in pugs.

# Sets up either the Null Prelude placeholder, or a real precompiled
# AST of Prelude.pm.

GetOptions \our %Config, qw(--null --pugs|p=s --inline|i=s);

precomp(), exit 0 if $Config{inline};
null(), exit 0 if $Config{null};
usage();
exit 1;

sub null {
    print STDERR "installing null prelude... " if $Config{verbose};
    open my $np, "src/Pugs/PreludePC.hs-null" or
        die "can't open null prelude: $!";
    print while (<$np>);
    print STDERR "done.\n" if $Config{verbose};
}

sub precomp {
    print STDERR "installing precompiled prelude... " if $Config{verbose};
    die "I need a pugs interpreter to precompile with" unless $Config{pugs};
    open my $pc, "$Config{pugs} -CPugs $Config{inline} |" or die "open: $!";
    print <<'.';
{-
    *** NOTE ***
    DO NOT EDIT THIS FILE.
    This module is automatically generated by util/gen_prelude.pl.
-}

{-|
    Perl 6 Prelude.
 
>   The world was fair, the mountains tall,
>   In Eldar Days before the fall
>   Of mighty kings in Nargothrond
>   And Gondolin, who now beyond
>   The Western Seas have passed away:
>   The world was fair in Durin's day.
 
-}

initPreludePC env = do
    ast <- astPCP                  -- what pugs -CPugs Prelude.pm gives,
    glob <- globPCP                -- made available here.
    globRef <- liftSTM $ do
        glob' <- readTVar $ envGlobal env
        newTVar (glob `unionPads` glob')
    runEnv env{ envBody = ast, envGlobal = globRef, envDebug = Nothing }
.
    while (<$pc>) {
        next if 1 .. /runAST/; # FIXME this is fragile.
        s/^globC/globPCP/;
        s/^expC/astPCP/;
        print;
    }
    print STDERR "done.\n" if $Config{verbose};
}

sub usage {
    print <<".";
usage: $0 --null
       $0 --inline src/perl6/Prelude.pm --pugs ./pugs.exe

Creates a PreludePC.hs file (written to stdout), to be included by Run.hs.

In the first build phase, a "null" prelude with only placeholder functions
is used. In the second phase, the Standard Prelude is precompiled and
inlined into the resulting pugs executable.
.
}
