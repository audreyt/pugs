#!/usr/bin/perl

use FindBin;
use File::Copy;

chdir "$FindBin::Bin/..";

unlink "dump.ast";
system("pugs", -C => @ARGV);
exit 1 unless -e "dump.ast";

copy ("src/Main.hs" => "src/MainCc.hs");

open FH, ">> src/MainCC.hs";
open AST, "dump.ast" or die $!;
print FH "\nmainCC = runAST \$ ";
print FH <AST>;
close AST;
close FH;

my $out = ($^O eq 'MSWin32') ? "a.exe" : "a.out";
system("ghc", "-v0", "-o", $out, "--make", "-main-is", "mainCC", "-isrc", "src/MainCC.hs");
unlink "src/MainCC.hs";
print "Generated output: $out\n";
